# Dynamic Application Security Testing (DAST) using OWASP ZAP (with Docker Hub login)
# Reads TARGET_URL from secret DAST_TARGET_URL and uses DOCKERHUB_USERNAME/DOCKERHUB_TOKEN to auth to Docker Hub.
# Place this file at .github/workflows/dast.yml
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  dast:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ secrets.DAST_TARGET_URL }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (jq, curl)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Verify target is reachable
        run: |
          echo "Checking target reachability..."
          for i in $(seq 1 10); do
            if curl -sSf "${TARGET_URL}" >/dev/null 2>&1; then
              echo "Target is reachable"
              exit 0
            fi
            echo "Waiting for target... ($i/10)"
            sleep 3
          done
          echo "Target not reachable (after 10 attempts)"
          exit 1

      - name: Pull ZAP image (login to Docker Hub if creds present)
        shell: bash
        run: |
          set -euo pipefail

          # Preferred docker image (Docker Hub)
          DOCKER_IMAGE="owasp/zap2docker-stable:latest"
          GHCR_IMAGE="ghcr.io/zaproxy/zap2docker-stable:latest"
          ZAP_IMAGE=""

          # Login to Docker Hub if credentials were provided
          if [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
            echo "Logging in to Docker Hub (credentials supplied)..."
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
          else
            echo "No Docker Hub credentials provided; attempting anonymous pull (may fail due to rate limits)."
          fi

          echo "Trying docker pull ${DOCKER_IMAGE} ..."
          if docker pull "${DOCKER_IMAGE}"; then
            ZAP_IMAGE="${DOCKER_IMAGE}"
            echo "Pulled ${DOCKER_IMAGE}"
          else
            echo "Failed to pull ${DOCKER_IMAGE}, trying GHCR fallback ${GHCR_IMAGE} ..."
            if docker pull "${GHCR_IMAGE}"; then
              ZAP_IMAGE="${GHCR_IMAGE}"
              echo "Pulled ${GHCR_IMAGE}"
            else
              echo "ERROR: Could not pull ZAP image from Docker Hub nor GHCR."
              echo "If you hit Docker Hub rate limits, add DOCKERHUB_USERNAME & DOCKERHUB_TOKEN secrets or use a self-hosted runner."
              exit 1
            fi
          fi

          echo "ZAP_IMAGE=${ZAP_IMAGE}" >> $GITHUB_ENV

      - name: Run OWASP ZAP baseline scan (container)
        run: |
          set -euo pipefail
          echo "Running ZAP baseline with image: $ZAP_IMAGE (output -> zap_baseline_report.html/json)"
          docker run --rm -v "$(pwd)":/zap/wrk/:rw -t "$ZAP_IMAGE" \
            zap-baseline.py -t "${TARGET_URL}" -r zap_baseline_report.html -j zap_baseline_report.json -q || true
          # We allow zap script to return non-zero; we'll inspect reports below.

      - name: Locate ZAP reports (debug)
        run: |
          echo "Report files found:"
          find . -type f \( -iname '*zap*report*.html' -o -iname '*zap*report*.json' -o -iname '*baseline*.html' -o -iname '*baseline*.json' \) -maxdepth 6 -print || true

      - name: Upload ZAP HTML report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: |
            **/*zap*report*.html
            **/*baseline*.html

      - name: Upload ZAP JSON report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-report
          path: |
            **/*zap*report*.json
            **/*baseline*.json

      - name: Fail if high/critical alerts found
        run: |
          set -euo pipefail
          json_file=$(find . -type f \( -iname '*zap*report*.json' -o -iname '*baseline*.json' \) -print -quit || true)
          if [ -n "$json_file" ] && [ -f "$json_file" ]; then
            echo "Using JSON report: $json_file"
            high_count=$(jq '[.site[]?.alerts[]? | select((.risk // "") == "High" or (.risk // "") == "Critical")] | length' "$json_file" 2>/dev/null || echo "0")
            echo "High/Critical alerts: $high_count"
            if [ "$high_count" -gt 0 ]; then
              echo "Failing build because of High/Critical DAST alerts"
              exit 1
            fi
          else
            echo "No JSON ZAP report found, skipping threshold check"
          fi
