# Dynamic Application Security Testing (DAST) using OWASP ZAP (Action)
# Uses the secret DAST_TARGET_URL to determine the target to scan.
# Place this file at .github/workflows/dast.yml
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  dast:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ secrets.DAST_TARGET_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (jq, curl)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Verify target is reachable
        run: |
          echo "Checking target reachability..."
          for i in $(seq 1 10); do
            if curl -sSf "${TARGET_URL}" >/dev/null 2>&1; then
              echo "Target is reachable"
              exit 0
            fi
            echo "Waiting for target... ($i/10)"
            sleep 3
          done
          echo "Target ${TARGET_URL} not reachable"
          exit 1

      - name: Run OWASP ZAP baseline scan (GitHub Action)
        # Use the zaproxy action which avoids docker pull issues on hosted runners
        uses: zaproxy/action-baseline-scan@v1
        with:
          target: ${{ secrets.DAST_TARGET_URL }}
          # opcionales:
          # failThreshold: 'High'   # la action puede fallar seg√∫n umbral, pero dejamos el manejo manual abajo

      - name: Locate ZAP reports (if any)
        run: |
          echo "Searching for likely ZAP report files..."
          find . -type f \( -iname '*zap*report*.html' -o -iname '*zap*report*.json' -o -iname '*baseline*.html' -o -iname '*baseline*.json' \) -maxdepth 6 -print || true

      - name: Upload ZAP HTML report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: |
            **/*zap*report*.html
            **/*baseline*.html

      - name: Upload ZAP JSON report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-report
          path: |
            **/*zap*report*.json
            **/*baseline*.json

      - name: Fail if high/critical alerts found
        run: |
          # Find a JSON report produced by ZAP (first match)
          json_file=$(find . -type f \( -iname '*zap*report*.json' -o -iname '*baseline*.json' \) -print -quit || true)
          if [ -n "$json_file" ] && [ -f "$json_file" ]; then
            echo "Using JSON report: $json_file"
            # Count High or Critical alerts (field names used by zap baseline JSON)
            high_count=$(jq '[.site[]?.alerts[]? | select(.risk == "High" or .risk == "Critical")] | length' "$json_file" || echo "0")
            echo "High/Critical alerts: $high_count"
            if [ "$high_count" -gt 0 ]; then
              echo "Failing build because of High/Critical DAST alerts"
              exit 1
            fi
          else
            echo "No JSON ZAP report found, skipping threshold check"
          fi
