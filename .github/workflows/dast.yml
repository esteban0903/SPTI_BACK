# Dynamic Application Security Testing (DAST) using OWASP ZAP (Docker fallback)
# Uses the secret DAST_TARGET_URL to determine the target to scan.
# Optionally uses DOCKERHUB_USERNAME and DOCKERHUB_TOKEN if Docker Hub requires auth.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  dast:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ secrets.DAST_TARGET_URL }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (jq, curl)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Verify target is reachable
        run: |
          echo "Checking target reachability..."
          for i in $(seq 1 10); do
            if curl -sSf "${TARGET_URL}" >/dev/null 2>&1; then
              echo "Target is reachable"
              exit 0
            fi
            echo "Waiting for target... ($i/10)"
            sleep 3
          done
          echo "Target ${TARGET_URL} not reachable"
          exit 1

      - name: Pull ZAP image (try GHCR then Docker Hub, optional login)
        run: |
          set -euo pipefail
          IMAGES="ghcr.io/zaproxy/zap2docker-stable:latest owasp/zap2docker-stable:latest"
          export ZAP_IMAGE=""
          for IMG in $IMAGES; do
            echo "Trying docker pull $IMG ..."
            if docker pull "$IMG"; then
              export ZAP_IMAGE="$IMG"
              echo "Pulled $IMG"
              break
            else
              echo "Failed to pull $IMG"
            fi
          done

          # If pull failed and DockerHub creds are provided, try login then pull again
          if [ -z "$ZAP_IMAGE" ] && [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
            echo "Attempting Docker Hub login and retry..."
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            for IMG in $IMAGES; do
              echo "Retrying docker pull $IMG ..."
              if docker pull "$IMG"; then
                export ZAP_IMAGE="$IMG"
                echo "Pulled $IMG after login"
                break
              else
                echo "Failed to pull $IMG even after login"
              fi
            done
          fi

          if [ -z "$ZAP_IMAGE" ]; then
            echo "ERROR: Could not pull any ZAP image (tried: $IMAGES)."
            echo "If you are hitting Docker Hub rate limits, create DOCKERHUB_USERNAME & DOCKERHUB_TOKEN secrets or use a self-hosted runner."
            exit 1
          fi

          echo "ZAP image to use: $ZAP_IMAGE"
          echo "ZAP_IMAGE=$ZAP_IMAGE" >> $GITHUB_ENV

      - name: Run OWASP ZAP baseline scan (container)
        run: |
          set -euo pipefail
          echo "Running ZAP baseline with image: $ZAP_IMAGE"
          docker run --rm -v "$(pwd)":/zap/wrk/:rw -t "$ZAP_IMAGE" \
            zap-baseline.py -t "${TARGET_URL}" -r zap_baseline_report.html -j zap_baseline_report.json -q || true
          # allow failure of zap command itself (we'll check reports), but continue to upload artifacts

      - name: Locate ZAP reports (if any)
        run: |
          echo "Searching for ZAP report files..."
          find . -type f \( -iname '*zap*report*.html' -o -iname '*zap*report*.json' -o -iname '*baseline*.html' -o -iname '*baseline*.json' \) -maxdepth 6 -print || true

      - name: Upload ZAP HTML report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: |
            **/*zap*report*.html
            **/*baseline*.html

      - name: Upload ZAP JSON report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-report
          path: |
            **/*zap*report*.json
            **/*baseline*.json

      - name: Fail if high/critical alerts found
        run: |
          set -euo pipefail
          json_file=$(find . -type f \( -iname '*zap*report*.json' -o -iname '*baseline*.json' \) -print -quit || true)
          if [ -n "$json_file" ] && [ -f "$json_file" ]; then
            echo "Using JSON report: $json_file"
            high_count=$(jq '[.site[]?.alerts[]? | select((.risk // "") == "High" or (.risk // "") == "Critical")] | length' "$json_file" || echo "0")
            echo "High/Critical alerts: $high_count"
            if [ "$high_count" -gt 0 ]; then
              echo "Failing build because of High/Critical DAST alerts"
              exit 1
            fi
          else
            echo "No JSON ZAP report found, skipping threshold check"
          fi
