# DAST workflow: intenta docker (con login si proporcionas DOCKERHUB_USERNAME/DOCKERHUB_TOKEN)
# y si falla hace fallback descargando ZAP standalone desde GitHub Releases y ejecutando el baseline.
# Coloca este archivo en .github/workflows/dast.yml
name: DAST

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  dast:
    name: DAST job
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ secrets.DAST_TARGET_URL }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl wget unzip python3 python3-pip openjdk-11-jre-headless

      - name: Verify target is reachable
        run: |
          echo "Checking target reachability..."
          if [ -z "${TARGET_URL:-}" ]; then
            echo "TARGET_URL is not set (secret missing)"
            exit 1
          fi
          for i in $(seq 1 10); do
            if curl -sSf "${TARGET_URL}" >/dev/null 2>&1; then
              echo "Target is reachable"
              exit 0
            fi
            echo "Waiting for target... ($i/10)"
            sleep 3
          done
          echo "Target not reachable (after 10 attempts)"
          exit 1

      - name: Try Docker pull (with optional login)
        id: pull_docker
        shell: bash
        run: |
          set -euo pipefail
          DOCKER_IMAGE="owasp/zap2docker-stable:latest"
          GHCR_IMAGE="ghcr.io/zaproxy/zap2docker-stable:latest"
          ZAP_IMAGE=""

          echo "DEBUG: DOCKERHUB_USERNAME set? -> ${DOCKERHUB_USERNAME:+yes}${DOCKERHUB_USERNAME:-no}"
          echo "Attempt Docker Hub login if credentials present..."
          if [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
            echo "Logging in to Docker Hub..."
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin || true
          else
            echo "No Docker Hub credentials provided; attempting anonymous pull (may fail due to rate limits)."
          fi

          echo "Attempting to pull ${DOCKER_IMAGE} ..."
          if docker pull "${DOCKER_IMAGE}" >/dev/null 2>&1; then
            ZAP_IMAGE="${DOCKER_IMAGE}"
            echo "Pulled ${DOCKER_IMAGE}"
          else
            echo "Failed to pull ${DOCKER_IMAGE}, trying GHCR fallback ${GHCR_IMAGE} ..."
            if docker pull "${GHCR_IMAGE}" >/dev/null 2>&1; then
              ZAP_IMAGE="${GHCR_IMAGE}"
              echo "Pulled ${GHCR_IMAGE}"
            else
              echo "Could not pull docker images (Docker Hub nor GHCR). Will fallback to standalone ZAP download."
            fi
          fi

          if [ -n "${ZAP_IMAGE}" ]; then
            echo "ZAP_IMAGE=${ZAP_IMAGE}" >> "$GITHUB_ENV"
            echo "pulled=true" >> "$GITHUB_OUTPUT"
            echo "Pulled image: ${ZAP_IMAGE}"
          else
            echo "pulled=false" >> "$GITHUB_OUTPUT"
            echo "No image pulled"
          fi

      - name: Debug: show pull_docker outputs
        continue-on-error: true
        run: |
          echo "Step outputs (pull_docker):"
          echo "pulled: ${{ steps.pull_docker.outputs.pulled }}"

      - name: Run ZAP via Docker if available
        if: steps.pull_docker.outputs.pulled == 'true'
        run: |
          set -euo pipefail
          echo "Running ZAP baseline via Docker image: $ZAP_IMAGE"
          docker run --rm -v "$(pwd)":/zap/wrk/:rw -t "$ZAP_IMAGE" \
            zap-baseline.py -t "${TARGET_URL}" -r zap_baseline_report.html -j zap_baseline_report.json -q || true

      - name: Fallback: Download and run standalone ZAP (if Docker pull not available)
        if: steps.pull_docker.outputs.pulled == 'false'
        run: |
          set -euo pipefail
          echo "Docker image not available, attempting standalone ZAP download + baseline run"

          ZAP_VERSION="2.13.0"
          ZAP_TAR="ZAP_${ZAP_VERSION//./_}_unix.tar.gz"
          REL_URL="https://github.com/zaproxy/zaproxy/releases/download/v${ZAP_VERSION}/${ZAP_TAR}"

          echo "Downloading ZAP from: $REL_URL"
          if ! curl -sSfL "$REL_URL" -o "$ZAP_TAR"; then
            echo "Failed to download ZAP release. Aborting fallback."
            exit 1
          fi

          mkdir -p zap-stable
          tar -xzf "$ZAP_TAR" -C zap-stable --strip-components=1
          ls -la zap-stable

          ZAP_PORT=8090
          echo "Starting ZAP daemon..."
          nohup ./zap-stable/zap.sh -daemon -port $ZAP_PORT -host 127.0.0.1 -config api.disablekey=true > zap-daemon.log 2>&1 &

          echo "Waiting for ZAP API to be ready..."
          for i in $(seq 1 60); do
            if curl -s "http://127.0.0.1:${ZAP_PORT}/" >/dev/null 2>&1; then
              echo "ZAP API reachable"
              break
            fi
            echo "Waiting for ZAP startup... ($i/60)"
            sleep 2
          done

          ZAP_BASELINE_URL="https://raw.githubusercontent.com/zaproxy/zaproxy/main/docker/zap-baseline.py"
          echo "Downloading zap-baseline.py from $ZAP_BASELINE_URL"
          if ! curl -sSfL "$ZAP_BASELINE_URL" -o zap-baseline.py; then
            ALT_URL="https://raw.githubusercontent.com/zaproxy/zap-baseline/master/zap-baseline.py"
            if ! curl -sSfL "$ALT_URL" -o zap-baseline.py; then
              echo "Cannot obtain zap-baseline.py. Aborting."
              exit 1
            fi
          fi
          chmod +x zap-baseline.py

          echo "Running zap-baseline.py against ${TARGET_URL} (via local ZAP daemon port ${ZAP_PORT})"
          python3 zap-baseline.py -t "${TARGET_URL}" -r zap_baseline_report.html -j zap_baseline_report.json -p ${ZAP_PORT} -q || true

      - name: Locate ZAP reports
        run: |
          echo "Searching for ZAP report files..."
          find . -type f \( -iname '*zap*report*.html' -o -iname '*zap*report*.json' -o -iname '*baseline*.html' -o -iname '*baseline*.json' \) -maxdepth 6 -print || true

      - name: Ensure artifact files exist (create diagnostics if none)
        run: |
          # If ZAP didn't produce reports, create a small diagnostic file so we always upload something
          if ! ls **/*zap*report*.json 2>/dev/null && ! ls **/*baseline*.json 2>/dev/null; then
            echo "No JSON report found. Creating diagnostic file." > status_no_report.txt
            echo "Check logs for errors and verify Docker/Download step." >> status_no_report.txt
          fi
          if ! ls **/*zap*report*.html 2>/dev/null && ! ls **/*baseline*.html 2>/dev/null; then
            echo "<html><body><h1>No ZAP HTML report produced</h1></body></html>" > zap_baseline_report.html
          fi

      - name: Upload ZAP HTML report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: |
            zap_baseline_report.html
            **/*zap*report*.html
            **/*baseline*.html
            status_no_report.txt

      - name: Upload ZAP JSON report(s)
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-report
          path: |
            zap_baseline_report.json
            **/*zap*report*.json
            **/*baseline*.json
            status_no_report.txt

      - name: Fail if high/critical alerts found (if JSON exists)
        run: |
          set -euo pipefail
          json_file=$(find . -type f \( -iname '*zap*report*.json' -o -iname '*baseline*.json' \) -print -quit || true)
          if [ -n "$json_file" ] && [ -f "$json_file" ]; then
            echo "Using JSON report: $json_file"
            high_count=$(jq '[.site[]?.alerts[]? | select((.risk // "") == "High" or (.risk // "") == "Critical")] | length' "$json_file" 2>/dev/null || echo "0")
            echo "High/Critical alerts: $high_count"
            if [ "$high_count" -gt 0 ]; then
              echo "Failing build because of High/Critical DAST alerts"
              exit 1
            fi
          else
            echo "No JSON ZAP report found, skipping threshold check"
          fi
